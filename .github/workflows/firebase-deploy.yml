name: Deploy Firebase Hosting

on:
  push:
    branches:
      - main
      - master
      - work
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Generate runtime app-config.js
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
          FIREBASE_VAPID_KEY: ${{ secrets.FIREBASE_VAPID_KEY }}
        run: |
          node <<'NODE'
          const fs = require('fs');

          const trimSecret = (value) =>
            String(value || '')
              .replace(/^\s+/, '')
              .replace(/,\s*$/, '')
              .trim();

          const extractFieldValue = (value, fieldName) => {
            const cleaned = trimSecret(value);
            if (!cleaned) return '';

            // Accept values accidentally copied as: fieldName: "value"
            const wrapped = cleaned.match(new RegExp(`^${fieldName}\\s*:\\s*["']([^"']+)["']$`));
            if (wrapped) return wrapped[1].trim();

            // Extract from a larger snippet (e.g. copied Firebase SDK example block)
            const fromSnippet = cleaned.match(new RegExp(`${fieldName}\\s*:\\s*["']([^"']+)["']`));
            if (fromSnippet) return fromSnippet[1].trim();

            // Remove outer quotes if present
            const quoted = cleaned.match(/^["'](.+)["']$/);
            if (quoted) return quoted[1].trim();

            return cleaned;
          };

          const env = process.env;
          const config = {
            supabaseUrl: trimSecret(env.SUPABASE_URL),
            supabaseAnonKey: trimSecret(env.SUPABASE_ANON_KEY),
            geminiApiKey: trimSecret(env.GEMINI_API_KEY),
            firebaseApiKey: extractFieldValue(env.FIREBASE_API_KEY, 'apiKey'),
            firebaseAuthDomain: extractFieldValue(env.FIREBASE_AUTH_DOMAIN, 'authDomain'),
            firebaseProjectId: extractFieldValue(env.FIREBASE_PROJECT_ID, 'projectId'),
            firebaseStorageBucket: extractFieldValue(env.FIREBASE_STORAGE_BUCKET, 'storageBucket'),
            firebaseMessagingSenderId: extractFieldValue(env.FIREBASE_MESSAGING_SENDER_ID, 'messagingSenderId'),
            firebaseAppId: extractFieldValue(env.FIREBASE_APP_ID, 'appId'),
            firebaseMeasurementId: extractFieldValue(env.FIREBASE_MEASUREMENT_ID, 'measurementId'),
            firebaseVapidKey: trimSecret(env.FIREBASE_VAPID_KEY)
          };

          const required = [
            'supabaseUrl',
            'supabaseAnonKey',
            'firebaseApiKey',
            'firebaseAuthDomain',
            'firebaseProjectId',
            'firebaseStorageBucket',
            'firebaseMessagingSenderId',
            'firebaseAppId',
            'firebaseVapidKey'
          ];

          for (const key of required) {
            if (!config[key]) {
              throw new Error(`Missing required secret value after normalization: ${key}`);
            }
          }

          fs.writeFileSync(
            'public/app-config.js',
            `window.__APP_CONFIG__ = ${JSON.stringify(config, null, 2)};\n`,
            'utf8'
          );
          NODE

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Install Firebase CLI
        run: npm i -g firebase-tools

      - name: Deploy to Firebase Hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: firebase deploy --only hosting --project yara-kids-b48ed --token "$FIREBASE_TOKEN"
